<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–£—á–∏—Ç–µ–ª—å –û–Ω–ª–∞–π–Ω V3.5.5</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    :root{
      --bg-light: #f4f6f9;
      --fg-light: #222;
      --card-light: #fff;
      --bg-dark: #1a1f36;
      --fg-dark: #e8eef7;
      --card-dark: #252d48;
      --input-bg-light: #fff;
      --input-bg-dark: #1a2236;
      --input-fg-light: #222;
      --input-fg-dark: #d4dce9;
      --input-border-light: #d1d5db;
      --input-border-dark: #3a4556;
      --primary: #0b5ea8;
      --muted: #8b92a9;
      --success: #16a34a;
      --danger: #dc2626;
    }
    html,body{height:100%;margin:0;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:var(--bg);color:var(--fg)}
    .container{max-width:1100px;margin:20px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:20px}
    h1{margin:0;font-size:24px;font-weight:600}
    .card{background:var(--card);padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(11,94,168,0.08)}
    input,textarea,select,button{padding:10px 12px;border-radius:8px;border:1px solid var(--input-border);font-size:14px;background:var(--input-bg);color:var(--input-fg);font-family:inherit}
    input,textarea,select{width:100%;margin-top:8px}
    textarea{min-height:90px;resize:vertical}
    .note-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .note-card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);transition:transform 0.2s}
    .note-card:hover{transform:translateY(-4px)}
    .note-card h4{margin:0 0 8px 0;font-size:16px;font-weight:600}
    .note-card p{margin:0;color:var(--muted);font-size:13px;line-height:1.5}
    .btn{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:500;transition:background 0.2s;display:inline-block}
    .btn:hover{background:#0a4a8a}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid var(--primary)}
    .btn.ghost:hover{background:rgba(11,94,168,0.1)}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.danger:hover{background:#b91c1c}
    .btn.success{background:var(--success);color:#fff}
    .btn.success:hover{background:#15803d}
    .btn.block{display:block;width:100%}
    .btn.small{padding:6px 12px;font-size:12px}
    .small{font-size:12px;color:var(--muted);margin-top:6px}
    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:12px}
    .btn-group{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .btn-group .btn{flex:1;min-width:100px}
    .edit-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
    .edit-modal.active{display:flex}
    .edit-container{background:var(--card);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:600px;padding:32px;margin:20px auto}
    .close-edit{position:absolute;top:16px;right:16px;background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted)}
    .test-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .test-modal.active{display:flex}
    .test-container{background:var(--card);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:700px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
    .test-header{background:linear-gradient(135deg,var(--primary),#0a4a8a);color:white;padding:24px}
    .test-title{margin:0;font-size:20px;font-weight:600}
    .test-progress{margin-top:12px;font-size:13px;opacity:0.9}
    .progress-bar{width:100%;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;margin-top:8px;overflow:hidden}
    .progress-fill{height:100%;background:rgba(255,255,255,0.8);border-radius:3px;transition:width 0.3s}
    .test-content{flex:1;padding:24px;overflow-y:auto}
    .question-box{margin-bottom:0}
    .question-number{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:8px}
    .question-text{font-size:16px;font-weight:600;margin:0 0 16px 0;color:var(--fg);word-wrap:break-word;overflow-wrap:break-word}
    .question-image{max-width:100%;height:auto;border-radius:8px;margin:16px 0;border:1px solid var(--input-border)}
    .answer-options{display:flex;flex-direction:column;gap:10px;margin-top:16px}
    .answer-option{display:flex;align-items:flex-start;gap:12px;padding:12px;border:2px solid var(--input-border);border-radius:8px;cursor:pointer;transition:all 0.2s;background:var(--input-bg)}
    .answer-option:hover{border-color:var(--primary);background:rgba(11,94,168,0.05)}
    .answer-option input{margin-top:4px;cursor:pointer;flex-shrink:0}
    .answer-option.selected{border-color:var(--primary);background:rgba(11,94,168,0.1);font-weight:500}
    .answer-text{flex:1;font-size:14px;word-wrap:break-word;overflow-wrap:break-word}
    .test-buttons{display:flex;gap:12px;padding:24px;border-top:1px solid var(--input-border);background:var(--card);flex-wrap:wrap}
    .test-buttons button{flex:1;min-width:100px}
    .test-result{text-align:center;padding:40px 20px}
    .result-score{font-size:48px;font-weight:700;color:var(--primary);margin:20px 0}
    .wizard-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
    .wizard-modal.active{display:flex}
    .wizard-container{background:var(--card);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:600px;padding:32px;margin:20px auto}
    .wizard-step{display:none}
    .wizard-step.active{display:block}
    .wizard-step h2{margin-top:0;color:var(--primary)}
    .close-wizard{position:absolute;top:16px;right:16px;background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted)}
    .pre-assign-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .pre-assign-modal.active{display:flex}
    .pre-assign-container{background:var(--card);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);width:100%;max-width:500px;padding:32px}
    .close-pre-assign{position:absolute;top:16px;right:16px;background:none;border:none;font-size:28px;cursor:pointer;color:var(--muted)}
    @media(max-width:720px){.note-grid{grid-template-columns:repeat(1,1fr)}.test-container{max-width:100%}.wizard-container{padding:20px}.edit-container{padding:20px}.pre-assign-container{padding:20px}.btn-group{flex-direction:column}.btn-group .btn{width:100%}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö –£—á–∏—Ç–µ–ª—å –û–Ω–ª–∞–π–Ω V3.5.5</h1>
      <div id="userInfo" class="small"></div>
    </header>
    <div id="loginBox" class="card login">
      <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
      <input id="login" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
      <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
      <button id="loginBtn" class="btn block" style="margin-top:12px">–í–æ–π—Ç–∏</button>
      <div id="loginError" class="small" style="color:var(--danger)"></div>
    </div>
    <div id="mainBox" style="display:none">
      <div class="card notes">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px"><h3>üìÑ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h3><button id="logoutBtn" class="btn ghost">–í—ã–π—Ç–∏</button></div>
        <input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞">
        <textarea id="desc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <input id="image" type="file" accept="image/*">
        <div style="display:flex;gap:8px;margin-top:12px"><button id="addNoteBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button><button id="refreshBtn" class="btn ghost">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
        <div id="notesList" class="note-grid"></div>
      </div>
      <div class="card news" style="margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px"><h3>üì∞ –ù–æ–≤–æ—Å—Ç–∏</h3><div id="newsAdminBtn" style="display:none"><button id="addNewsBtn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div>
        <div id="newsForm" style="display:none;margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.05);border-radius:8px">
          <input id="newsTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
          <textarea id="newsDesc" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ"></textarea>
          <input id="newsImage" type="file" accept="image/*">
          <div style="display:flex;gap:8px;margin-top:8px"><button id="saveNewsBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="cancelNewsBtn" class="btn ghost">–û—Ç–º–µ–Ω–∏—Ç—å</button></div>
        </div>
        <div id="newsList" class="note-grid"></div>
      </div>
      <div class="card guides" style="margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px"><h3>üìö –ü–æ—Å–æ–±–∏—è</h3><div id="guidesAdminBtn" style="display:none"><button id="addGuideBtn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å</button></div></div>
        <div id="guidesForm" style="display:none;margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.05);border-radius:8px">
          <input id="guideTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
          <textarea id="guideDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
          <input id="guideImage" type="file" accept="image/*">
          <div style="display:flex;gap:8px;margin-top:8px"><button id="saveGuideBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button id="cancelGuideBtn" class="btn ghost">–û—Ç–º–µ–Ω–∏—Ç—å</button></div>
        </div>
        <div id="guidesList" class="note-grid"></div>
      </div>
      <div id="testsPanel" class="card tests" style="margin-top:16px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px"><h3>üß™ –¢–µ—Å—Ç—ã</h3><div id="testsAdminBtn" style="display:none"><button id="createTestBtn" class="btn">+ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</button></div></div>
        <div id="testsList" class="note-grid"></div>
      </div>
      <div id="adminPanel" class="card admin" style="display:none;margin-top:16px">
        <h3>‚öôÔ∏è –£—á–∏—Ç–µ–ª—å—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h3>
        <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <input id="u_login" placeholder="–õ–æ–≥–∏–Ω" style="flex:1;min-width:120px">
          <input id="u_pass" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1;min-width:120px">
          <select id="u_role" style="flex:1;min-width:100px"><option value="student">–£—á–µ–Ω–∏–∫</option><option value="admin">–ê–¥–º–∏–Ω</option></select>
          <button id="saveUserBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
          <input id="del_login" placeholder="–õ–æ–≥–∏–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è" style="flex:1;min-width:150px">
          <button id="delUserBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px"><label>–¢–µ–º–∞:</label><select id="themeSel"><option value="light">–°–≤–µ—Ç–ª–∞—è</option><option value="dark">–¢—ë–º–Ω–∞—è</option></select></div>
        <h4 style="margin-top:16px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
        <div id="usersList" class="small" style="max-height:150px;overflow-y:auto;border:1px solid var(--input-border);padding:8px;border-radius:8px"></div>
        <h4 style="margin-top:16px">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</h4>
        <button id="loadResultsBtn" class="btn ghost" style="margin-bottom:8px">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
        <div id="resultsList" class="small" style="max-height:150px;overflow-y:auto"></div>
      </div>
    </div>
  </div>
  <footer class="small">–£—á–∏—Ç–µ–ª—å –û–Ω–ª–∞–π–Ω –≤–µ—Ä—Å–∏–∏ 3.5.5TEST. –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ —Å–≤–æ–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –≤ –¢–ì: @winmatwey</footer>
  <div id="testModal" class="test-modal">
    <div class="test-container">
      <div class="test-header"><h2 class="test-title" id="testModalTitle">–¢–µ—Å—Ç</h2><div class="test-progress">–í–æ–ø—Ä–æ—Å <span id="currentQuestion">1</span> –∏–∑ <span id="totalQuestions">10</span></div><div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div></div>
      <div class="test-content"><div id="testQuestionsContainer"></div><div id="testResultContainer" style="display:none"></div></div>
      <div class="test-buttons"><button id="prevBtn" class="btn ghost">‚Üê –ù–∞–∑–∞–¥</button><button id="nextBtn" class="btn">–î–∞–ª–µ–µ ‚Üí</button><button id="submitBtn" class="btn" style="display:none">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å</button><button id="closeTestBtn" class="btn ghost" style="display:none">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
  </div>
  <div id="wizardModal" class="wizard-modal">
    <div class="wizard-container">
      <button class="close-wizard" id="closeWizardBtn">‚úï</button>
      <div class="wizard-step active" id="step1"><h2>–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞</h2><label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞:</label><input id="wizTestTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"><label style="margin-top:12px">–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label><textarea id="wizTestDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea><button class="btn" style="width:100%;margin-top:16px" onclick="nextWizardStep()">–î–∞–ª–µ–µ</button></div>
      <div class="wizard-step" id="step2"><h2>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤</h2><div id="questionsListWiz" style="margin-top:12px;max-height:300px;overflow-y:auto"></div><button class="btn ghost" style="width:100%;margin-top:12px" onclick="addQuestionToWiz()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button><div style="display:flex;gap:8px;margin-top:16px"><button class="btn ghost" style="flex:1" onclick="prevWizardStep()">‚Üê –ù–∞–∑–∞–¥</button><button class="btn" style="flex:1" onclick="finishWizard()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>
    </div>
  </div>
  <div id="editModal" class="edit-modal">
    <div class="edit-container">
      <button class="close-edit" id="closeEditBtn">‚úï</button>
      <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</h2>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><input id="editTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞">
      <label style="margin-top:12px">–û–ø–∏—Å–∞–Ω–∏–µ:</label><textarea id="editDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
      <label style="margin-top:12px">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/–§–∞–π–ª:</label><input id="editImage" type="file" accept="image/*">
      <div style="display:flex;gap:8px;margin-top:16px"><button class="btn ghost" style="flex:1" onclick="closeEditMaterial()">–û—Ç–º–µ–Ω–∏—Ç—å</button><button class="btn" style="flex:1" id="saveEditBtn" onclick="saveEditedMaterial()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  </div>
  <div id="preAssignModal" class="pre-assign-modal">
    <div class="pre-assign-container">
      <button class="close-pre-assign" id="closePreAssignBtn">‚úï</button>
      <h2 style="color:var(--primary);margin-top:0">üë§ –ù–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª —É—á–µ–Ω–∏–∫—É</h2>
      <p style="color:var(--muted);margin:12px 0">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–º—É –Ω–∞–∑–Ω–∞—á–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª, –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç–æ –¥–ª—è –≤—Å–µ—Ö</p>
      <label style="font-weight:600">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞:</label>
      <select id="preAssignUserSelect" style="margin-top:8px;width:100%;padding:10px;border-radius:8px;border:1px solid var(--input-border)"><option value="">üì¢ –í—Å–µ–º (–≤–∏–¥–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)</option></select>
      <div style="display:flex;gap:8px;margin-top:20px"><button class="btn ghost" style="flex:1" onclick="cancelPreAssign()">–û—Ç–º–µ–Ω–∏—Ç—å</button><button class="btn" style="flex:1" id="confirmPreAssignBtn" onclick="confirmPreAssign()">‚úì –î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª</button></div>
    </div>
  </div>

<script>
const API="";let current="",role="",currentPass="";let currentTestData=null;let currentQuestionIndex=0;let testAnswers=[];let wizardQuestions=[];let currentEditIndex=-1;let currentEditIsOwnMaterial=false;let pendingNoteData=null;let isAdminAddingNote=false;function el(id){return document.getElementById(id)}async function api(path,opts){opts=opts||{};opts.headers=opts.headers||{'Content-Type':'application/json'};try{return await fetch(path,opts)}catch(e){throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω')}}async function loginAction(){el('loginError').textContent='';const l=el('login').value.trim(),p=el('password').value;if(!l||!p){el('loginError').textContent='–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å';return}try{const r=await api('/login',{method:'POST',body:JSON.stringify({login:l,password:p})});const d=await r.json();if(!d.ok){el('loginError').textContent=d.error||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';return}current=l;role=d.role;currentPass=p;el('loginBox').style.display='none';el('mainBox').style.display='block';el('userInfo').textContent=current+(role?' ('+role+')':'');if(role==='admin'){el('adminPanel').style.display='block';el('testsAdminBtn').style.display='block';el('newsAdminBtn').style.display='block';el('guidesAdminBtn').style.display='block';loadUsersList();loadUsers();loadAvailableUsers()}loadNotes();loadNews();loadGuides();loadTests();loadTheme()}catch(e){console.error(e);el('loginError').textContent='–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'}}el('loginBtn').addEventListener('click',loginAction);el('password').addEventListener('keypress',(e)=>{if(e.key==='Enter')loginAction()});el('logoutBtn').addEventListener('click',()=>location.reload());function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}function fileToDataURL(file){return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(file)})}async function adminPost(path,payload){payload=payload||{};payload.admin_login=current;payload.admin_password=currentPass;return await api(path,{method:'POST',body:JSON.stringify(payload)})}async function loadNotes(){try{const r=await api('/notes');const arr=await r.json();const list=el('notesList');list.innerHTML='';arr.forEach((n,idx)=>{if(role!=='admin'&&n.assignedTo&&n.assignedTo!==current&&n.user!==current){return}const card=document.createElement('div');card.className='note-card';card.innerHTML=`<h4>${escapeHtml(n.title)}</h4><p>${escapeHtml(n.desc)}</p><div class="small">–ê–≤—Ç–æ—Ä: ${escapeHtml(n.user)}</div>`;if(n.assignedTo){const assignedLabel=document.createElement('div');assignedLabel.className='small';assignedLabel.style.marginTop='6px';assignedLabel.style.color='var(--primary)';assignedLabel.textContent='üë§ –ù–∞–∑–Ω–∞—á–µ–Ω–æ: '+escapeHtml(n.assignedTo);card.appendChild(assignedLabel)}if(n.image){const img=document.createElement('img');img.src=n.image;img.style.maxWidth='100%';img.style.marginTop='8px';card.appendChild(img)}const btnGroup=document.createElement('div');btnGroup.className='btn-group';const downloadBtn=document.createElement('button');downloadBtn.className='btn success small';downloadBtn.textContent='üì• –°–∫–∞—á–∞—Ç—å';downloadBtn.onclick=()=>downloadNoteFiles(n);btnGroup.appendChild(downloadBtn);const isOwnMaterial=n.user===current;const canEdit=(role==='admin')||(role==='student'&&isOwnMaterial);if(canEdit){const editBtn=document.createElement('button');editBtn.className='btn small';editBtn.textContent='‚úèÔ∏è –†–µ–¥–∞–∫—Ç.';editBtn.onclick=()=>openEditMaterial(idx,n,isOwnMaterial);btnGroup.appendChild(editBtn)}if(role==='admin'&&n.assignedTo){const assignBtn=document.createElement('button');assignBtn.className='btn small';assignBtn.style.background='#8b5cf6';assignBtn.textContent='üë§ –ò–∑–º.–Ω–∞–∑–Ω–∞—á.';assignBtn.onclick=()=>openAdminAssignModal(idx,n);btnGroup.appendChild(assignBtn);const delBtn=document.createElement('button');delBtn.className='btn danger small';delBtn.textContent='–£–¥–∞–ª–∏—Ç—å';delBtn.onclick=async ()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;await adminPost('/admin/notes/delete',{index:idx});loadNotes()};btnGroup.appendChild(delBtn)}else if(role==='admin'){const delBtn=document.createElement('button');delBtn.className='btn danger small';delBtn.textContent='–£–¥–∞–ª–∏—Ç—å';delBtn.onclick=async ()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;await adminPost('/admin/notes/delete',{index:idx});loadNotes()};btnGroup.appendChild(delBtn)}card.appendChild(btnGroup);list.appendChild(card)})}catch(e){console.error(e)}}async function loadAvailableUsers(){try{const r=await adminPost('/admin/users/list',{});const usersData=await r.json();const select=el('preAssignUserSelect');select.innerHTML='<option value="">üì¢ –í—Å–µ–º (–≤–∏–¥–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)</option>';for(const username in usersData){if(usersData[username].role==='student'){const option=document.createElement('option');option.value=username;option.textContent='üë§ '+username;select.appendChild(option)}}}catch(e){console.error(e)}}function openAdminAssignModal(idx,note){isAdminAddingNote=false;pendingNoteData=null;currentEditIndex=idx;el('preAssignUserSelect').value=note.assignedTo||'';el('preAssignModal').classList.add('active')}function openPreAssignModal(){isAdminAddingNote=true;currentEditIndex=-1;el('preAssignUserSelect').value='';el('preAssignModal').classList.add('active')}function cancelPreAssign(){el('preAssignModal').classList.remove('active');el('preAssignUserSelect').value='';currentEditIndex=-1;pendingNoteData=null;isAdminAddingNote=false;el('title').value='';el('desc').value='';el('image').value=''}async function confirmPreAssign(){if(isAdminAddingNote&&pendingNoteData){const assignedTo=el('preAssignUserSelect').value;pendingNoteData.assignedTo=assignedTo;try{await api('/notes',{method:'POST',body:JSON.stringify(pendingNoteData)});const msgText=assignedTo?`‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω —É—á–µ–Ω–∏–∫—É: ${assignedTo}`:'‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';alert(msgText);el('preAssignModal').classList.remove('active');el('preAssignUserSelect').value='';el('title').value='';el('desc').value='';el('image').value='';pendingNoteData=null;isAdminAddingNote=false;loadNotes()}catch(e){console.error(e);alert('–û—à–∏–±–∫–∞ ÔøΩÔøΩ—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞')}}else if(!isAdminAddingNote&&currentEditIndex>=0){const assignedTo=el('preAssignUserSelect').value;try{const r=await adminPost('/admin/materials/assign',{index:currentEditIndex,assigned_to:assignedTo});const j=await r.json();if(!r.ok||!j.ok){alert(j.error||'–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏');return}alert('‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');el('preAssignModal').classList.remove('active');currentEditIndex=-1;loadNotes()}catch(e){console.error(e);alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏')}}}el('closePreAssignBtn').addEventListener('click',cancelPreAssign);function openEditMaterial(idx,note,isOwnMaterial){currentEditIndex=idx;currentEditIsOwnMaterial=isOwnMaterial;el('editTitle').value=note.title||'';el('editDesc').value=note.desc||'';el('editImage').value='';el('editModal').classList.add('active')}function closeEditMaterial(){el('editModal').classList.remove('active');el('editTitle').value='';el('editDesc').value='';el('editImage').value='';currentEditIndex=-1;currentEditIsOwnMaterial=false}async function saveEditedMaterial(){if(currentEditIndex<0)return;const newTitle=el('editTitle').value.trim();const newDesc=el('editDesc').value.trim();const fileInput=el('editImage');let newImage='';if(fileInput.files&&fileInput.files[0]){newImage=await fileToDataURL(fileInput.files[0])}try{let r;if(currentEditIsOwnMaterial&&role==='student'){const payload={username:current,index:currentEditIndex,title:newTitle,desc:newDesc};if(newImage){payload.image=newImage}r=await api('/materials/edit',{method:'POST',body:JSON.stringify(payload)})}else if(role==='admin'){const payload={index:currentEditIndex,title:newTitle,desc:newDesc};if(newImage){payload.image=newImage}r=await adminPost('/admin/materials/edit',payload)}else{alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');return}const j=await r.json();if(!r.ok||!j.ok){alert(j.error||'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏');return}alert('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω');closeEditMaterial();loadNotes()}catch(e){console.error(e);alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π')}}el('closeEditBtn').addEventListener('click',closeEditMaterial);async function downloadNoteFiles(note){const text=`–ù–∞–∑–≤–∞–Ω–∏–µ: ${note.title}\n–ê–≤—Ç–æ—Ä: ${note.user}\n\n–û–ø–∏—Å–∞–Ω–∏–µ:\n${note.desc}`;const blob=new Blob([text],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(note.title||'material').replace(/\s+/g,'_')+'.txt';a.click();URL.revokeObjectURL(a.href);if(note.image){try{const response=await fetch(note.image);const blob=await response.blob();const ext=response.headers.get('content-type').split('/')[1]||'png';const a2=document.createElement('a');a2.href=URL.createObjectURL(blob);a2.download=(note.title||'material').replace(/\s+/g,'_')+'.'+ext;a2.click();URL.revokeObjectURL(a2.href)}catch(e){const parts=note.image.split(',');const meta=parts[0];const b64=parts[1]||'';const mime=(meta.match(/data:(.*);base64/)||[null,'image/png'])[1];const ext=mime.split('/')[1]||'png';const byteChars=atob(b64);const byteNumbers=new Array(byteChars.length);for(let i=0;i<byteChars.length;i++)byteNumbers[i]=byteChars.charCodeAt(i);const byteArray=new Uint8Array(byteNumbers);const blobImg=new Blob([byteArray],{type:mime});const a2=document.createElement('a');a2.href=URL.createObjectURL(blobImg);a2.download=(note.title||'material').replace(/\s+/g,'_')+'.'+ext;a2.click();URL.revokeObjectURL(a2.href)}}}async function addNote(){if(!current){alert('–í–æ–π–¥–∏—Ç–µ');return}const t=el('title').value.trim(),d=el('desc').value.trim();const f=el('image').files[0];if(!t){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞');return}let img='';if(f)img=await fileToDataURL(f);const noteData={title:t,desc:d,user:current,image:img,assignedTo:''};if(role==='admin'){pendingNoteData=noteData;openPreAssignModal()}else{try{await api('/notes',{method:'POST',body:JSON.stringify(noteData)});alert('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');el('title').value='';el('desc').value='';el('image').value='';loadNotes()}catch(e){console.error(e);alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞')}}}el('addNoteBtn').addEventListener('click',addNote);el('refreshBtn').addEventListener('click',loadNotes);async function loadNews(){try{const r=await api('/news');const arr=await r.json();const list=el('newsList');list.innerHTML='';arr.forEach((n,idx)=>{const card=document.createElement('div');card.className='note-card';card.innerHTML=`<h4>${escapeHtml(n.title)}</h4><p>${escapeHtml(n.desc)}</p>`;if(n.image){const img=document.createElement('img');img.src=n.image;img.style.maxWidth='100%';img.style.marginTop='8px';card.appendChild(img)}if(role==='admin'){const btnGroup=document.createElement('div');btnGroup.className='btn-group';const del=document.createElement('button');del.className='btn danger small';del.textContent='–£–¥–∞–ª–∏—Ç—å';del.onclick=async ()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;await adminPost('/admin/news/delete',{index:idx});loadNews()};btnGroup.appendChild(del);card.appendChild(btnGroup)}list.appendChild(card)})}catch(e){console.error(e)}}async function addNews(){if(!current){alert('–í–æ–π–¥–∏—Ç–µ');return}const t=el('newsTitle').value.trim(),d=el('newsDesc').value.trim();const f=el('newsImage').files[0];let img='';if(f)img=await fileToDataURL(f);await api('/news',{method:'POST',body:JSON.stringify({title:t,desc:d,user:current,image:img})});el('newsTitle').value='';el('newsDesc').value='';el('newsImage').value='';el('newsForm').style.display='none';loadNews()}el('addNewsBtn')?.addEventListener('click',()=>el('newsForm').style.display='block');el('cancelNewsBtn')?.addEventListener('click',()=>el('newsForm').style.display='none');el('saveNewsBtn')?.addEventListener('click',addNews);async function loadGuides(){try{const r=await api('/guides');const arr=await r.json();const list=el('guidesList');list.innerHTML='';arr.forEach((g,idx)=>{const card=document.createElement('div');card.className='note-card';card.innerHTML=`<h4>${escapeHtml(g.title)}</h4><p>${escapeHtml(g.desc)}</p>`;if(g.image){const img=document.createElement('img');img.src=g.image;img.style.maxWidth='100%';img.style.marginTop='8px';card.appendChild(img)}const btnGroup=document.createElement('div');btnGroup.className='btn-group';const download=document.createElement('button');download.className='btn success small';download.textContent='üì• –°–∫–∞—á–∞—Ç—å';download.onclick=()=>downloadGuideFiles(g);btnGroup.appendChild(download);if(role==='admin'){const del=document.createElement('button');del.className='btn danger small';del.textContent='–£–¥–∞–ª–∏—Ç—å';del.onclick=async ()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å?'))return;await adminPost('/admin/guides/delete',{index:idx});loadGuides()};btnGroup.appendChild(del)}card.appendChild(btnGroup);list.appendChild(card)})}catch(e){console.error(e)}}async function downloadGuideFiles(guide){const text=`–ù–∞–∑–≤–∞–Ω–∏–µ: ${guide.title}\n–ê–≤—Ç–æ—Ä: ${guide.user}\n\n–û–ø–∏—Å–∞–Ω–∏–µ:\n${guide.desc}`;const blob=new Blob([text],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(guide.title||'guide').replace(/\s+/g,'_')+'.txt';a.click();URL.revokeObjectURL(a.href);if(guide.image){try{const response=await fetch(guide.image);const blob=await response.blob();const ext=response.headers.get('content-type').split('/')[1]||'png';const a2=document.createElement('a');a2.href=URL.createObjectURL(blob);a2.download=(guide.title||'guide').replace(/\s+/g,'_')+'.'+ext;a2.click();URL.revokeObjectURL(a2.href)}catch(e){const parts=guide.image.split(',');const meta=parts[0];const b64=parts[1]||'';const mime=(meta.match(/data:(.*);base64/)||[null,'image/png'])[1];const ext=mime.split('/')[1]||'png';const byteChars=atob(b64);const byteNumbers=new Array(byteChars.length);for(let i=0;i<byteChars.length;i++)byteNumbers[i]=byteChars.charCodeAt(i);const byteArray=new Uint8Array(byteNumbers);const blobImg=new Blob([byteArray],{type:mime});const a2=document.createElement('a');a2.href=URL.createObjectURL(blobImg);a2.download=(guide.title||'guide').replace(/\s+/g,'_')+'.'+ext;a2.click();URL.revokeObjectURL(a2.href)}}}async function addGuide(){if(!current){alert('–í–æ–π–¥–∏—Ç–µ');return}const t=el('guideTitle').value.trim(),d=el('guideDesc').value.trim();const f=el('guideImage').files[0];let img='';if(f)img=await fileToDataURL(f);await api('/guides',{method:'POST',body:JSON.stringify({title:t,desc:d,user:current,image:img})});el('guideTitle').value='';el('guideDesc').value='';el('guideImage').value='';el('guidesForm').style.display='none';loadGuides()}el('addGuideBtn')?.addEventListener('click',()=>el('guidesForm').style.display='block');el('cancelGuideBtn')?.addEventListener('click',()=>el('guidesForm').style.display='none');el('saveGuideBtn')?.addEventListener('click',addGuide);async function loadUsers(){try{const r=await adminPost('/admin/users/list',{});const u=await r.json();const div=el('usersList');div.innerHTML='';for(const k of Object.keys(u)){const item=document.createElement('div');item.style.padding='6px 0';item.style.borderBottom='1px solid var(--input-border)';item.textContent=escapeHtml(k)+' ‚Äî '+escapeHtml(u[k].role);div.appendChild(item)}}catch(e){console.error(e)}}async function loadUsersList(){try{const r=await adminPost('/admin/users/list',{});const u=await r.json()}catch(e){console.error(e)}}async function saveUser(){const login=el('u_login').value.trim(),pass=el('u_pass').value,roleSel=el('u_role').value;if(!login){alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');return}const payload={login:login,role:roleSel};if(pass)payload.password=pass;try{const r=await adminPost('/admin/users/add_or_update',payload);const j=await r.json();if(!r.ok)alert(j.error||'–û—à–∏–±–∫–∞');else{loadUsers();loadAvailableUsers();el('u_login').value='';el('u_pass').value=''}}catch(e){console.error(e)}}async function delUser(){const login=el('del_login').value.trim();if(!login)return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');try{const r=await adminPost('/admin/users/delete',{login});const j=await r.json();if(!r.ok)alert(j.error||'–û—à–∏–±–∫–∞');else{loadUsers();loadAvailableUsers();el('del_login').value=''}}catch(e){console.error(e)}}async function loadTheme(){try{const r=await api('/admin/settings/theme');const j=await r.json();el('themeSel').value=j.theme||'light';applyTheme(j.theme||'light')}catch(e){applyTheme('light')}}async function changeTheme(){const theme=el('themeSel').value;try{await adminPost('/admin/settings/theme',{theme});applyTheme(theme)}catch(e){console.error(e)}}function applyTheme(theme){if(theme==='dark'){document.documentElement.style.setProperty('--bg','var(--bg-dark)');document.documentElement.style.setProperty('--fg','var(--fg-dark)');document.documentElement.style.setProperty('--card','var(--card-dark)');document.documentElement.style.setProperty('--input-bg','var(--input-bg-dark)');document.documentElement.style.setProperty('--input-fg','var(--input-fg-dark)');document.documentElement.style.setProperty('--input-border','var(--input-border-dark)')}else{document.documentElement.style.setProperty('--bg','var(--bg-light)');document.documentElement.style.setProperty('--fg','var(--fg-light)');document.documentElement.style.setProperty('--card','var(--card-light)');document.documentElement.style.setProperty('--input-bg','var(--input-bg-light)');document.documentElement.style.setProperty('--input-fg','var(--input-fg-light)');document.documentElement.style.setProperty('--input-border','var(--input-border-light)')}}el('saveUserBtn').addEventListener('click',saveUser);el('delUserBtn').addEventListener('click',delUser);el('themeSel').addEventListener('change',changeTheme);el('loadResultsBtn').addEventListener('click',async ()=>{try{const r=await adminPost('/admin/results',{});const j=await r.json();const div=el('resultsList');div.innerHTML='';if(Array.isArray(j)){j.forEach(res=>{const item=document.createElement('div');item.style.padding='6px 0';item.style.borderBottom='1px solid var(--input-border)';item.textContent=escapeHtml(res.user)+' ‚Äî —Ç–µ—Å—Ç #'+res.test_id+': '+res.score+'/'+res.total;div.appendChild(item)})}}catch(e){console.error(e)}});async function loadTests(){try{const r=await api('/tests');const arr=await r.json();const list=el('testsList');list.innerHTML='';arr.forEach((t)=>{const card=document.createElement('div');card.className='note-card';const desc=t.desc?`<p>${escapeHtml(t.desc)}</p>`:'';card.innerHTML=`<h4>${escapeHtml(t.title)}</h4>${desc}<p class="small">${t.questions.length} –≤–æ–ø—Ä–æ—Å–æ–≤</p>`;const btn=document.createElement('button');btn.className='btn ghost';btn.textContent='–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç';btn.style.width='100%';btn.style.marginTop='8px';btn.onclick=()=>startTestUI(t);card.appendChild(btn);if(role==='admin'){const delBtn=document.createElement('button');delBtn.className='btn danger';delBtn.textContent='–£–¥–∞–ª–∏—Ç—å';delBtn.style.width='100%';delBtn.style.marginTop='8px';delBtn.onclick=async ()=>{if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç?'))return;try{await adminPost('/admin/tests/delete',{id:t.id});loadTests()}catch(e){console.error(e)}};card.appendChild(delBtn)}list.appendChild(card)})}catch(e){console.error(e)}}function startTestUI(test){currentTestData=test;currentQuestionIndex=0;testAnswers=new Array(test.questions.length).fill(null);el('testModal').classList.add('active');el('testModalTitle').textContent=test.title;el('totalQuestions').textContent=test.questions.length;el('testResultContainer').innerHTML='';el('testResultContainer').style.display='none';el('testQuestionsContainer').style.display='block';renderTestQuestion()}function renderTestQuestion(){const questions=currentTestData.questions;const q=questions[currentQuestionIndex];const container=el('testQuestionsContainer');container.innerHTML='';let html=`<div class="question-box"><div class="question-number">–í–æ–ø—Ä–æ—Å ${currentQuestionIndex+1} –∏–∑ ${questions.length}</div><div class="question-text">${escapeHtml(q.q)}</div>`;if(q.image){html+=`<img src="${q.image}" class="question-image" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞">`}html+=`<div class="answer-options" id="answersContainer"></div></div>`;container.innerHTML=html;const answersContainer=el('answersContainer');q.choices.forEach((choice,idx)=>{const isSelected=testAnswers[currentQuestionIndex]===idx;const inputId=`ans_${idx}`;let optionHtml=`<label class="answer-option ${isSelected?'selected':''}"><input type="radio" id="${inputId}" name="answer" value="${idx}" ${isSelected?'checked':''}><div class="answer-text">${escapeHtml(choice)}</div></label>`;answersContainer.innerHTML+=optionHtml});document.querySelectorAll('input[name="answer"]').forEach(input=>{input.addEventListener('change',(e)=>{testAnswers[currentQuestionIndex]=parseInt(e.target.value);document.querySelectorAll('.answer-option').forEach(opt=>opt.classList.remove('selected'));e.target.closest('.answer-option').classList.add('selected')})});updateButtons();updateProgress()}function updateProgress(){const progress=((currentQuestionIndex+1)/currentTestData.questions.length)*100;el('progressFill').style.width=progress+'%';el('currentQuestion').textContent=currentQuestionIndex+1}function updateButtons(){el('prevBtn').disabled=currentQuestionIndex===0;el('nextBtn').style.display=currentQuestionIndex<currentTestData.questions.length-1?'block':'none';el('submitBtn').style.display=currentQuestionIndex===currentTestData.questions.length-1?'block':'none'}el('prevBtn').addEventListener('click',()=>{if(currentQuestionIndex>0){currentQuestionIndex--;renderTestQuestion()}});el('nextBtn').addEventListener('click',()=>{if(currentQuestionIndex<currentTestData.questions.length-1){currentQuestionIndex++;renderTestQuestion()}});el('submitBtn').addEventListener('click',async ()=>{try{const r=await api('/tests/submit',{method:'POST',body:JSON.stringify({test_id:currentTestData.id,answers:testAnswers,user:current})});const result=await r.json();showTestResult(result)}catch(e){console.error(e);alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏')}});function showTestResult(result){el('testQuestionsContainer').style.display='none';let percentage=result.percentage||0;let message='';if(percentage>=80)message='üéâ –û—Ç–ª–∏—á–Ω–æ!';else if(percentage>=60)message='üëç –•–æ—Ä–æ—à–æ!';else if(percentage>=40)message='‚ö†Ô∏è –ù—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å';else message='‚ùå –ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏';let html=`<div class="test-result"><h3>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!</h3><div class="result-score">${result.score}/${result.total}</div><div style="font-size:18px;color:var(--muted);margin-bottom:16px">${percentage}%</div><div style="font-size:16px">${message}</div></div>`;el('testResultContainer').innerHTML=html;el('testResultContainer').style.display='block';el('prevBtn').style.display='none';el('nextBtn').style.display='none';el('submitBtn').style.display='none';el('closeTestBtn').style.display='block'}el('closeTestBtn').addEventListener('click',()=>{el('testModal').classList.remove('active');el('testResultContainer').style.display='none';el('testQuestionsContainer').style.display='block';el('testResultContainer').innerHTML='';el('prevBtn').style.display='block';el('closeTestBtn').style.display='none'});el('createTestBtn')?.addEventListener('click',()=>{wizardQuestions=[];el('wizTestTitle').value='';el('wizTestDesc').value='';showWizardStep(1);el('wizardModal').classList.add('active')});el('closeWizardBtn').addEventListener('click',()=>el('wizardModal').classList.remove('active'));function showWizardStep(step){document.querySelectorAll('.wizard-step').forEach(s=>s.classList.remove('active'));el('step'+step).classList.add('active')}function nextWizardStep(){const title=el('wizTestTitle').value.trim();if(!title){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞');return}showWizardStep(2);renderQuestionsWiz()}function prevWizardStep(){showWizardStep(1)}function addQuestionToWiz(){const q=prompt('–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞:');if(!q)return;const c=prompt('–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):');if(!c)return;const a=prompt('–ù–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (1,2,3...):','1');if(!a)return;const idx=parseInt(a)-1;const choices=c.split(',').map(x=>x.trim());if(idx<0||idx>=choices.length){alert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –æ—Ç–≤–µ—Ç–∞');return}wizardQuestions.push({q:q,choices:choices,type:'single',answers:[idx],image:''});renderQuestionsWiz()}function renderQuestionsWiz(){const div=el('questionsListWiz');div.innerHTML='';wizardQuestions.forEach((q,idx)=>{const item=document.createElement('div');item.style.padding='12px';item.style.background='rgba(11,94,168,0.05)';item.style.borderRadius='8px';item.style.marginBottom='8px';item.style.borderLeft='4px solid var(--primary)';const choices=q.choices.map((c,i)=>`${i+1}. ${escapeHtml(c)}${q.answers.includes(i)?' ‚úì':''}`).join('<br>');item.innerHTML=`<strong>–í–æ–ø—Ä–æ—Å ${idx+1}:</strong> ${escapeHtml(q.q)}<br><div style="font-size:12px;margin-top:8px;color:var(--muted)">${choices}</div><button class="btn danger" style="width:100%;margin-top:8px;padding:6px" onclick="deleteQuestionWiz(${idx})">–£–¥–∞–ª–∏—Ç—å</button>`;div.appendChild(item)})}function deleteQuestionWiz(idx){wizardQuestions.splice(idx,1);renderQuestionsWiz()}async function finishWizard(){const title=el('wizTestTitle').value.trim();if(!title||wizardQuestions.length===0){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã');return}const test={title:title,desc:el('wizTestDesc').value.trim(),questions:wizardQuestions};try{const r=await adminPost('/admin/tests/add_or_update',{test});const j=await r.json();if(!r.ok)alert(j.error||'–û—à–∏–±–∫–∞');else{alert('‚úÖ –¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');el('wizardModal').classList.remove('active');loadTests()}}catch(e){console.error(e);alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')}}applyTheme('light');
</script>
</body>
</html>
