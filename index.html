<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–ö–æ–Ω—Å–ø–µ–∫—Ç—ã ‚Äî –ö–ª–∞—Å—Å</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:1000px;margin:18px auto;padding:12px}
    h1{text-align:center}
    form{border:1px solid #e6e6e6;padding:10px;border-radius:8px;margin-bottom:12px}
    input,textarea,select,button{display:block;width:100%;padding:8px;margin-top:8px;box-sizing:border-box}
    .note{border:1px solid #ddd;padding:10px;border-radius:8px;margin-bottom:10px}
    img{max-width:240px;border-radius:6px;margin-top:8px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .small{font-size:13px;color:#666}
    .btn{background:#0b5ea8;color:white;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .btn.secondary{background:#e6eef7;color:#0b5ea8}
    .error{color:red;font-weight:600}
  </style>
</head>
<body>
  <h1>üìö –ö–æ–Ω—Å–ø–µ–∫—Ç—ã ‚Äî –ö–ª–∞—Å—Å</h1>

  <div id="loginBox">
    <form id="loginForm">
      <label>Login</label>
      <input id="login" placeholder="login" required />
      <label>Password</label>
      <input id="password" type="password" placeholder="password" required />
      <button class="btn" type="submit">–í–æ–π—Ç–∏</button>
      <p id="loginError" class="small error"></p>
      <p class="small">–ï—Å–ª–∏ –≤—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ —Ñ–∞–π–ª `index.html` –Ω–∞–ø—Ä—è–º—É—é (file://), —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ <code>http://localhost:5000</code>.</p>
    </form>
  </div>

  <div id="mainBox" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><b id="currentUser"></b> <span id="currentRole" class="small"></span></div>
      <div>
        <button id="logoutBtn" class="btn secondary">–í—ã–π—Ç–∏</button>
        <button id="adminToggle" class="btn" style="display:none">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="row">
      <div class="col">
        <form id="uploadForm">
          <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç</h3>
          <input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
          <textarea id="desc" placeholder="–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
          <input id="image" type="file" accept="image/*" />
          <button class="btn" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>

        <h3>–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤</h3>
        <div id="notes"></div>
      </div>

      <div class="col" style="max-width:380px">
        <div id="adminPanel" style="display:none">
          <h3>–ê–¥–º–∏–Ω: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
          <div id="usersList" class="small"></div>

          <form id="userForm">
            <h4>–î–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
            <input id="u_login" placeholder="login" required />
            <input id="u_pass" placeholder="password (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)" />
            <select id="u_role">
              <option value="student">student</option>
              <option value="admin">admin</option>
            </select>
            <button class="btn" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
          </form>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const API = (location.protocol === 'file:' ? 'http://localhost:5000' : location.origin);

let current = "";
let currentRole = "";
let currentPassword = ""; // stored in session for admin actions (cleared on logout)

const loginForm = document.getElementById('loginForm');
const loginError = document.getElementById('loginError');
const loginBox = document.getElementById('loginBox');
const mainBox = document.getElementById('mainBox');
const currentUserEl = document.getElementById('currentUser');
const currentRoleEl = document.getElementById('currentRole');
const notesEl = document.getElementById('notes');
const adminPanel = document.getElementById('adminPanel');
const adminToggle = document.getElementById('adminToggle');

async function safeFetch(url, opts){
  try{
    const r = await fetch(url, opts);
    return r;
  }catch(e){
    console.error("Network error:", e);
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ " + API);
  }
}

async function doLogin(login, password) {
  loginError.textContent = "";
  let r;
  try{
    r = await safeFetch(API + "/login", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({login, password})
    });
  }catch(e){
    loginError.textContent = e.message;
    return false;
  }
  const data = await r.json().catch(()=>({}));
  if (!r.ok) {
    loginError.textContent = data.error || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
    return false;
  }
  current = login;
  currentRole = data.role || "student";
  currentPassword = password; // keep in session (improves UX for admin tasks)
  currentUserEl.textContent = current;
  currentRoleEl.textContent = "(" + currentRole + ")";
  loginBox.style.display = "none";
  mainBox.style.display = "block";
  if (currentRole === "admin") {
    adminToggle.style.display = "inline-block";
  } else {
    adminToggle.style.display = "none";
  }
  await loadNotes();
  return true;
}

loginForm.onsubmit = async e => {
  e.preventDefault();
  await doLogin(document.getElementById('login').value.trim(), document.getElementById('password').value);
};

document.getElementById('logoutBtn').onclick = () => {
  current = ""; currentRole = ""; currentPassword = "";
  location.reload();
};

document.getElementById('uploadForm').onsubmit = async e => {
  e.preventDefault();
  if (!current) return alert("–í–æ–π–¥–∏—Ç–µ");
  let imgData = "";
  const f = document.getElementById('image').files[0];
  if (f) {
    imgData = await fileToDataURL(f);
  }
  await safeFetch(API + "/notes", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      title: document.getElementById('title').value,
      desc: document.getElementById('desc').value,
      user: current,
      image: imgData
    })
  });
  e.target.reset();
  await loadNotes();
};

async function loadNotes(){
  const r = await safeFetch(API + "/notes");
  const arr = await r.json();
  notesEl.innerHTML = "";
  arr.forEach((n, idx) => {
    const d = document.createElement('div');
    d.className = "note";
    d.innerHTML = `<b>${escapeHtml(n.title)}</b><div class="small">${escapeHtml(n.desc)}</div>` +
                  (n.image ? `<img src="${n.image}">` : "") +
                  `<div class="small">–î–æ–±–∞–≤–∏–ª: ${escapeHtml(n.user)}</div>`;
    const dlBtn = document.createElement('button');
    dlBtn.className = 'btn secondary';
    dlBtn.textContent = '–°–∫–∞—á–∞—Ç—å';
    dlBtn.onclick = () => downloadNoteZip(n);
    d.appendChild(dlBtn);
    if (currentRole === "admin") {
      const editBtn = document.createElement('button');
      editBtn.className = 'btn secondary';
      editBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
      editBtn.onclick = () => editNotePrompt(idx, n);
      const delBtn = document.createElement('button');
      delBtn.className = 'btn';
      delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
      delBtn.onclick = () => deleteNote(idx);
      d.appendChild(editBtn); d.appendChild(delBtn);
    }
    notesEl.appendChild(d);
  });
}

async function deleteNote(idx) {
  const payload = await adminAuthPayload();
  if (!payload) return;
  payload.index = idx;
  const r = await safeFetch(API + "/admin/notes/delete", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const res = await r.json().catch(()=>({}));
  if (!r.ok) return alert("–û—à–∏–±–∫–∞: " + (res.error || "unknown"));
  await loadNotes();
}

async function editNotePrompt(idx, note) {
  const newTitle = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:", note.title);
  if (newTitle === null) return;
  const newDesc = prompt("–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:", note.desc);
  if (newDesc === null) return;
  let newImage = null;
  if (confirm("–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É? (–û—Ç–º–µ–Ω–∞ ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–∂–Ω—é—é)")) {
    const f = await pickFile();
    if(f) newImage = await fileToDataURL(f);
  }
  const payload = await adminAuthPayload();
  if (!payload) return;
  payload.index = idx;
  payload.title = newTitle;
  payload.desc = newDesc;
  if (newImage !== null) payload.image = newImage;
  const r = await safeFetch(API + "/admin/notes/update", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const res = await r.json().catch(()=>({}));
  if (!r.ok) return alert("–û—à–∏–±–∫–∞: " + (res.error || "unknown"));
  await loadNotes();
}

async function adminAuthPayload() {
  if (currentRole !== 'admin') return null;
  if (currentPassword) return { admin_login: current, admin_password: currentPassword };
  const admin_password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:");
  if (!admin_password) return null;
  return { admin_login: current, admin_password };
}

adminToggle.onclick = async () => {
  adminPanel.style.display = adminPanel.style.display === 'none' ? 'block' : 'none';
  if (adminPanel.style.display === 'block') await loadUsers();
};

async function loadUsers(){
  const payload = await adminAuthPayload();
  if (!payload) return;
  const r = await safeFetch(API + "/admin/users/list", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  if (!r.ok) { alert("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–∞"); return; }
  const users = await r.json();
  const list = document.getElementById('usersList');
  list.innerHTML = "";
  Object.keys(users).forEach(k=>{
    const u = users[k];
    const row = document.createElement('div');
    row.className = 'small';
    row.innerHTML = `<b>${escapeHtml(k)}</b> ‚Äî ${escapeHtml(u.role)} &nbsp; 
      <button class="btn secondary" onclick="adminPrefill('${encodeURIComponent(k)}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn" onclick="adminDeleteUser('${encodeURIComponent(k)}')">–£–¥–∞–ª–∏—Ç—å</button>`;
    list.appendChild(row);
  });
}

window.adminPrefill = async function(encodedLogin){
  const login = decodeURIComponent(encodedLogin);
  const payload = await adminAuthPayload();
  if (!payload) return;
  const r = await safeFetch(API + "/admin/users/list", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  if (!r.ok) return alert("–û—à–∏–±–∫–∞");
  const users = await r.json();
  const u = users[login];
  if (!u) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
  document.getElementById('u_login').value = login;
  document.getElementById('u_pass').value = '';
  document.getElementById('u_role').value = u.role || 'student';
};

async function adminDeleteUser(encodedLogin){
  if (!confirm("–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;
  const login = decodeURIComponent(encodedLogin);
  const payload = await adminAuthPayload();
  if (!payload) return;
  payload.login = login;
  const r = await safeFetch(API + "/admin/users/delete", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const res = await r.json().catch(()=>null);
  if (!r.ok) return alert("–û—à–∏–±–∫–∞: " + (res && res.error || 'unknown'));
  await loadUsers();
}

document.getElementById('userForm').onsubmit = async e => {
    e.preventDefault();
    const payload = await adminAuthPayload();
    if (!payload) return;
    payload.login = document.getElementById('u_login').value.trim();
    const passVal = document.getElementById('u_pass').value;
    if (passVal && passVal.trim() !== '') payload.password = passVal;
    payload.role = document.getElementById('u_role').value;
    const r = await safeFetch(API + "/admin/users/add_or_update", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const res = await r.json().catch(()=>({}));
    if (!r.ok) {
      alert("–û—à–∏–±–∫–∞: " + (res.error || 'unknown'));
      return;
    }
    alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
    document.getElementById('u_login').value = '';
    document.getElementById('u_pass').value = '';
    await loadUsers();
};

// download ZIP code
async function downloadNoteZip(note){
  const zip = new JSZip();
  const text = `–ù–∞–∑–≤–∞–Ω–∏–µ: ${note.title}\n–ê–≤—Ç–æ—Ä: ${note.user}\n\n–û–ø–∏—Å–∞–Ω–∏–µ:\n${note.desc}`;
  zip.file("note.txt", text);
  if (note.image) {
    const parts = note.image.split(",");
    const meta = parts[0]; const b64 = parts[1];
    const mime = (meta.match(/data:(.*);base64/) || [null, "image/png"])[1];
    const ext = mime.split("/")[1] || "png";
    zip.file("image." + ext, b64, {base64: true});
  }
  const blob = await zip.generateAsync({type:"blob"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (note.title||"note").replace(/\s+/g,"_") + ".zip";
  a.click();
  URL.revokeObjectURL(a.href);
}

function pickFile() {
  return new Promise(res => {
    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*';
    inp.onchange = ()=> res(inp.files[0] || null);
    inp.click();
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }
</script>
</body>
</html>
