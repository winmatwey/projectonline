<!-- index.html ‚Äî –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–æ–µ–∫—Ç–∞ -->

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–£—á–∏—Ç–µ–ª—å –û–Ω–ª–∞–π–Ω</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg-light: #f4f6f9;
      --fg-light: #222;
      --card-light: #fff;
      --bg-dark: #1a1f36;
      --fg-dark: #e8eef7;
      --card-dark: #252d48;
      --input-bg-light: #fff;
      --input-bg-dark: #1a2236;
      --input-fg-light: #222;
      --input-fg-dark: #d4dce9;
      --input-border-light: #d1d5db;
      --input-border-dark: #3a4556;
      --primary: #0b5ea8;
      --muted: #8b92a9;
      --success: #16a34a;
      --danger: #dc2626;
    }
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--fg)}
    .container{max-width:1100px;margin:20px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(11,94,168,0.06)}
    .login, .notes, .news, .guides, .admin{margin-top:16px}
    input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid var(--input-border);box-sizing:border-box;margin-top:8px;font-size:14px;background:var(--input-bg);color:var(--input-fg)}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .note-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .note-card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    .note-card h4{margin:0 0 6px 0;font-size:16px}
    .note-card p{margin:0;color:var(--muted);font-size:13px}
    .btn{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,94,168,0.12)}
    .btn.danger{background:var(--danger)}
    .small{font-size:12px;color:var(--muted);margin-top:6px}
    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
    .form-row{display:flex;gap:12px;margin-top:8px}
    .form-row > *{flex:1}
    .assign-section{display:none;margin-top:12px;padding:12px;background:rgba(0,0,0,0.05);border-radius:8px}
    .radio-group{display:flex;gap:16px;margin-top:8px;align-items:center}
    .radio-group label{margin:0;display:flex;align-items:center;gap:6px;font-size:14px;cursor:pointer}
    .radio-group input[type="radio"]{margin:0;width:auto}
    @media(max-width:720px){ .row{flex-direction:column} .note-grid{grid-template-columns:repeat(1,1fr)} .form-row{flex-direction:column} .form-row > *{flex:1} .radio-group{flex-direction:column;align-items:flex-start} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö –£—á–∏—Ç–µ–ª—å –û–Ω–ª–∞–π–Ω</h1>
      <div id="userInfo" class="small"></div>
    </header>

    <div id="loginBox" class="card login">
      <h3>–í—Ö–æ–¥</h3>
      <input id="login" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
      <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
      <div><button id="loginBtn" class="btn">–í–æ–π—Ç–∏</button></div>
      <div id="loginError" class="small" style="color:var(--danger)"></div>
    </div>

    <div id="mainBox" style="display:none">
      <!-- –ú–ê–¢–ï–†–ò–ê–õ–´ -->
      <div class="card notes">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <h3>üìÑ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã</h3>
          <div><button id="logoutBtn" class="btn ghost">–í—ã–π—Ç–∏</button></div>
        </div>
        <input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞">
        <textarea id="desc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <input id="image" type="file" accept="image/*">
        
        <!-- –í—ã–±–æ—Ä –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
        <div class="assign-section" id="assignSection">
          <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:8px">üìå –ö–æ–º—É –Ω–∞–∑–Ω–∞—á–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª:</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="visibility" value="all" checked>
              –í—Å–µ–º
            </label>
            <label>
              <input type="radio" name="visibility" value="specific">
              –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            </label>
          </div>
          <select id="assignUser" style="display:none">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
          </select>
        </div>
        
        <div style="display:flex;gap:8px;margin-top:8px"><button id="addNoteBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button><button id="refreshBtn" class="btn ghost">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button></div>
        <div id="notesList" class="note-grid"></div>
      </div>

      <!-- –ù–û–í–û–°–¢–ò -->
      <div class="card news" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <h3>üì∞ –ù–æ–≤–æ—Å—Ç–∏</h3>
          <div id="newsAdminBtn" style="display:none"><button id="addNewsBtn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button></div>
        </div>
        
        <div id="newsForm" style="display:none;margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.05);border-radius:8px">
          <input id="newsTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏">
          <textarea id="newsDesc" placeholder="–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏"></textarea>
          <input id="newsImage" type="file" accept="image/*">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveNewsBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="cancelNewsBtn" class="btn ghost">–û—Ç–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
        
        <div id="newsList" class="note-grid"></div>
      </div>

      <!-- –ü–û–°–û–ë–ò–Ø -->
      <div class="card guides" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <h3>üìö –ü–æ—Å–æ–±–∏—è</h3>
          <div id="guidesAdminBtn" style="display:none"><button id="addGuideBtn" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–æ–±–∏–µ</button></div>
        </div>
        
        <div id="guidesForm" style="display:none;margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.05);border-radius:8px">
          <input id="guideTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å–æ–±–∏—è">
          <textarea id="guideDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–æ–±–∏—è"></textarea>
          <input id="guideImage" type="file" accept="image/*">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveGuideBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="cancelGuideBtn" class="btn ghost">–û—Ç–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
        
        <div id="guidesList" class="note-grid"></div>
      </div>

      <!-- –¢–ï–°–¢–´ -->
      <div id="testsPanel" class="card tests" style="margin-top:12px">
        <h3>üß™ –¢–µ—Å—Ç—ã</h3>
        <div id="testsList" class="note-grid"></div>
      </div>

      <!-- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ -->
      <div id="adminPanel" class="card admin" style="display:none">
        <h3>‚öôÔ∏è –£—á–∏—Ç–µ–ª—å—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h3>
        <div style="display:flex;gap:12px;margin-bottom:8px">
          <input id="u_login" placeholder="–õ–æ–≥–∏–Ω">
          <input id="u_pass" placeholder="–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)">
          <select id="u_role"><option value="student">–£—á–µ–Ω–∏–∫</option><option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option></select>
          <button id="saveUserBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:8px">
          <input id="del_login" placeholder="–õ–æ–≥–∏–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è">
          <button id="delUserBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <label>–¢–µ–º–∞:</label>
          <select id="themeSel"><option value="light">–°–≤–µ—Ç–ª–∞—è</option><option value="dark">–¢—ë–º–Ω–∞—è</option></select>
        </div>
        <h4 style="margin-top:12px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏</h4>
        <div style="margin-bottom:8px">
          <input id="testTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞">
          <textarea id="testQuestions" placeholder='JSON –≤–æ–ø—Ä–æ—Å–æ–≤ (–ø—Ä–∏–º–µ—Ä: [{"q":"–í–æ–ø—Ä–æ—Å","choices":["a","b"],"correct":1}])' style="min-height:80px"></textarea>
          <button id="saveTestBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ—Å—Ç</button>
          <input id="delTestId" placeholder="ID —Ç–µ—Å—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è">
          <button id="delTestBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç</button>
          <h4 style="margin-top:8px">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h4>
          <button id="loadResultsBtn" class="btn ghost">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
          <div id="resultsList" class="small" style="margin-top:8px"></div>
        </div>

        <h4 style="margin-top:12px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
        <div id="usersList" class="small"></div>
      </div>
    </div>

    <footer class="small">–£—á–∏—Ç–µ–ª—å –û–Ω–ª–∞–π–Ω –≤–µ—Ä—Å–∏–∏ 3.0.1TEST 
      –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –≤ —Å–≤–æ–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö –æ–±—Ä–∞—Ç–∞–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–µ—Ä–≤–∏—Å–∞ –≤ –¢–ì: @winmatwey</footer>
  </div>

<script>
const API = "";
let current="", role="", currentPass="";

function el(id){return document.getElementById(id)}

async function api(path, opts){opts = opts || {}; opts.headers = opts.headers || {'Content-Type':'application/json'};
  try{const r = await fetch(path, opts); return r;}catch(e){throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç.')}}

async function loginAction(){
  el('loginError').textContent = '';
  const l = el('login').value.trim(), p = el('password').value;
  if(!l||!p){ el('loginError').textContent='–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; return; }
  const r = await api('/login',{method:'POST', body: JSON.stringify({login:l,password:p})});
  const d = await r.json();
  if(!d.ok){ el('loginError').textContent = d.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'; return; }
  current = l; role = d.role; currentPass = p;
  el('loginBox').style.display='none'; el('mainBox').style.display='block';
  el('userInfo').textContent = current + (role?' ('+role+')':'');
  if(role==='admin') {
    el('adminPanel').style.display='block';
    el('assignSection').style.display='block';
    loadUsersList();
  }
  
  if(role==='admin') {
    el('newsAdminBtn').style.display='block';
    el('guidesAdminBtn').style.display='block';
  }
  
  loadNotes(); loadNews(); loadGuides(); 
  if(role==='admin') loadUsers(); 
  loadTheme();
}

async function loadUsersList(){
  const r = await adminPost('/admin/users/list', {}); 
  const u = await r.json(); 
  const select = el('assignUser');
  select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>';
  for(const k of Object.keys(u)) {
    const opt = document.createElement('option');
    opt.value = k;
    opt.textContent = k + ' (' + u[k].role + ')';
    select.appendChild(opt);
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
document.addEventListener('change', function(e) {
  if(e.target.name === 'visibility') {
    const select = el('assignUser');
    if(e.target.value === 'specific') {
      select.style.display = 'block';
      select.required = true;
    } else {
      select.style.display = 'none';
      select.required = false;
      select.value = '';
    }
  }
});

el('loginBtn').addEventListener('click', loginAction);
el('logoutBtn').addEventListener('click', ()=>location.reload());
el('addNoteBtn').addEventListener('click', addNote);
el('refreshBtn').addEventListener('click', loadNotes);
el('saveUserBtn').addEventListener('click', saveUser);
el('delUserBtn').addEventListener('click', delUser);
el('themeSel').addEventListener('change', changeTheme);

// NEWS functions
el('addNewsBtn')?.addEventListener('click', ()=>el('newsForm').style.display='block');
el('cancelNewsBtn')?.addEventListener('click', ()=>el('newsForm').style.display='none');
el('saveNewsBtn')?.addEventListener('click', addNews);

async function loadNews(){
  const r = await api('/news'); const arr = await r.json();
  const list = el('newsList'); list.innerHTML='';
  arr.forEach((n, idx)=>{
    const card = document.createElement('div'); card.className='note-card';
    card.innerHTML = `<h4>${escapeHtml(n.title)}</h4><p>${escapeHtml(n.desc)}</p><div class="small">–ê–≤—Ç–æ—Ä: ${escapeHtml(n.user)}</div>`;
    if(n.image){ const img = document.createElement('img'); img.src = n.image; img.style.maxWidth='100%'; img.style.marginTop='8px'; card.appendChild(img); }
    const btnRow = document.createElement('div'); btnRow.style.marginTop='8px';
    const dl = document.createElement('button'); dl.className='btn ghost'; dl.textContent='–°–∫–∞—á–∞—Ç—å'; dl.onclick = ()=>downloadNoteFiles(n);
    btnRow.appendChild(dl);
    if(role==='admin'){
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.style.marginLeft='8px';
      del.onclick = async ()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å?')) return; await adminPost('/admin/news/delete',{index:idx}); loadNews(); };
      btnRow.appendChild(del);
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; edit.style.marginLeft='8px';
      edit.onclick = ()=>editNewsPrompt(idx,n);
      btnRow.appendChild(edit);
    }
    card.appendChild(btnRow);
    list.appendChild(card);
  });
}

async function addNews(){
  if(!current){ alert('–í–æ–π–¥–∏—Ç–µ'); return; }
  const t = el('newsTitle').value.trim(), d = el('newsDesc').value.trim();
  const f = el('newsImage').files[0]; let img='';
  if(f) img = await fileToDataURL(f);
  await api('/news',{method:'POST', body: JSON.stringify({title:t,desc:d,user:current,image:img})});
  el('newsTitle').value=''; el('newsDesc').value=''; el('newsImage').value='';
  el('newsForm').style.display='none';
  loadNews();
}

async function editNewsPrompt(idx,news){
  const newTitle = prompt('–ù–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫', news.title); if(newTitle===null) return;
  const newDesc = prompt('–ù–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ', news.desc); if(newDesc===null) return;
  const changeImg = confirm('–ó–∞–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ? OK ‚Äî –≤—ã–±—Ä–∞—Ç—å, Cancel ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–∂–Ω–µ–µ');
  let newImage = undefined;
  if(changeImg){
    const f = await pickFile(); if(f) newImage = await fileToDataURL(f);
  }
  const payload = {index: idx, title: newTitle, desc: newDesc}; if(newImage!==undefined) payload.image = newImage;
  const r = await adminPost('/admin/news/update', payload); const j = await r.json(); if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else loadNews();
}

// GUIDES functions
el('addGuideBtn')?.addEventListener('click', ()=>el('guidesForm').style.display='block');
el('cancelGuideBtn')?.addEventListener('click', ()=>el('guidesForm').style.display='none');
el('saveGuideBtn')?.addEventListener('click', addGuide);

async function loadGuides(){
  const r = await api('/guides'); const arr = await r.json();
  const list = el('guidesList'); list.innerHTML='';
  arr.forEach((g, idx)=>{
    const card = document.createElement('div'); card.className='note-card';
    card.innerHTML = `<h4>${escapeHtml(g.title)}</h4><p>${escapeHtml(g.desc)}</p><div class="small">–ê–≤—Ç–æ—Ä: ${escapeHtml(g.user)}</div>`;
    if(g.image){ const img = document.createElement('img'); img.src = g.image; img.style.maxWidth='100%'; img.style.marginTop='8px'; card.appendChild(img); }
    const btnRow = document.createElement('div'); btnRow.style.marginTop='8px';
    const dl = document.createElement('button'); dl.className='btn ghost'; dl.textContent='–°–∫–∞—á–∞—Ç—å'; dl.onclick = ()=>downloadNoteFiles(g);
    btnRow.appendChild(dl);
    if(role==='admin'){
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.style.marginLeft='8px';
      del.onclick = async ()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–æ–±–∏–µ?')) return; await adminPost('/admin/guides/delete',{index:idx}); loadGuides(); };
      btnRow.appendChild(del);
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; edit.style.marginLeft='8px';
      edit.onclick = ()=>editGuidePrompt(idx,g);
      btnRow.appendChild(edit);
    }
    card.appendChild(btnRow);
    list.appendChild(card);
  });
}

async function addGuide(){
  if(!current){ alert('–í–æ–π–¥–∏—Ç–µ'); return; }
  const t = el('guideTitle').value.trim(), d = el('guideDesc').value.trim();
  const f = el('guideImage').files[0]; let img='';
  if(f) img = await fileToDataURL(f);
  await api('/guides',{method:'POST', body: JSON.stringify({title:t,desc:d,user:current,image:img})});
  el('guideTitle').value=''; el('guideDesc').value=''; el('guideImage').value='';
  el('guidesForm').style.display='none';
  loadGuides();
}

async function editGuidePrompt(idx,guide){
  const newTitle = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', guide.title); if(newTitle===null) return;
  const newDesc = prompt('–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ', guide.desc); if(newDesc===null) return;
  const changeImg = confirm('–ó–∞–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ? OK ‚Äî –≤—ã–±—Ä–∞—Ç—å, Cancel ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–∂–Ω–µ–µ');
  let newImage = undefined;
  if(changeImg){
    const f = await pickFile(); if(f) newImage = await fileToDataURL(f);
  }
  const payload = {index: idx, title: newTitle, desc: newDesc}; if(newImage!==undefined) payload.image = newImage;
  const r = await adminPost('/admin/guides/update', payload); const j = await r.json(); if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else loadGuides();
}

// MATERIALS functions
async function loadNotes(){
  const r = await api('/notes'); const arr = await r.json();
  const list = el('notesList'); list.innerHTML='';
  arr.forEach((n, idx)=>{
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
    // –í–∏–¥–Ω–æ –µ—Å–ª–∏: 1) –î–ª—è –≤—Å–µ—Ö (assignedTo –ø—É—Å—Ç), 2) –ù–∞–∑–Ω–∞—á–µ–Ω–æ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, 3) –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    const isVisible = !n.assignedTo || n.assignedTo === current || role === 'admin';
    
    if(!isVisible) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª, –µ—Å–ª–∏ –æ–Ω –Ω–µ –≤–∏–¥–∏–º—ã–π —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    
    const card = document.createElement('div'); card.className='note-card';
    let assignedText = '';
    if(n.assignedTo) {
      assignedText = `<div class="small" style="color:var(--primary);margin-top:4px">üìå –¢–æ–ª—å–∫–æ –¥–ª—è: ${escapeHtml(n.assignedTo)}</div>`;
    } else {
      assignedText = `<div class="small" style="color:var(--success);margin-top:4px">üåç –î–ª—è –≤—Å–µ—Ö</div>`;
    }
    card.innerHTML = `<h4>${escapeHtml(n.title)}</h4><p>${escapeHtml(n.desc)}</p><div class="small">–ê–≤—Ç–æ—Ä: ${escapeHtml(n.user)}</div>${assignedText}`;
    if(n.image){ const img = document.createElement('img'); img.src = n.image; img.style.maxWidth='100%'; img.style.marginTop='8px'; card.appendChild(img); }
    const btnRow = document.createElement('div'); btnRow.style.marginTop='8px';
    const dl = document.createElement('button'); dl.className='btn ghost'; dl.textContent='–°–∫–∞—á–∞—Ç—å'; dl.onclick = ()=>downloadNoteFiles(n);
    btnRow.appendChild(dl);
    if(role==='admin'){
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.style.marginLeft='8px';
      del.onclick = async ()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª?')) return; await adminPost('/admin/notes/delete',{index:idx}); loadNotes(); };
      btnRow.appendChild(del);
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; edit.style.marginLeft='8px';
      edit.onclick = ()=>editNotePrompt(idx,n);
      btnRow.appendChild(edit);
    }
    card.appendChild(btnRow);
    list.appendChild(card);
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function addNote(){
  if(!current){ alert('–í–æ–π–¥–∏—Ç–µ'); return; }
  const t = el('title').value.trim(), d = el('desc').value.trim();
  const f = el('image').files[0]; let img='';
  if(f) img = await fileToDataURL(f);
  
  // –ü–æ–ª—É—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏
  const visibility = document.querySelector('input[name="visibility"]:checked').value;
  let assignedTo = '';
  
  if(visibility === 'specific') {
    assignedTo = el('assignUser').value;
    if(!assignedTo) {
      alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
      return;
    }
  }
  
  await api('/notes',{method:'POST', body: JSON.stringify({title:t,desc:d,user:current,image:img,assignedTo:assignedTo})});
  el('title').value=''; el('desc').value=''; el('image').value='';
  document.querySelector('input[name="visibility"][value="all"]').checked = true;
  el('assignUser').style.display = 'none';
  el('assignUser').value = '';
  loadNotes();
}

function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

async function downloadNoteFiles(note){
  const text = `–ù–∞–∑–≤–∞–Ω–∏–µ: ${note.title}\n–ê–≤—Ç–æ—Ä: ${note.user}\n\n–û–ø–∏—Å–∞–Ω–∏–µ:\n${note.desc}`;
  const blob = new Blob([text], {type: 'text/plain'});
  const a1 = document.createElement('a'); a1.href = URL.createObjectURL(blob); a1.download = (note.title||'note').replace(/\s+/g,'_') + '.txt'; a1.click(); URL.revokeObjectURL(a1.href);
  if(note.image){
    const parts = note.image.split(','); const meta = parts[0]; const b64 = parts[1] || '';
    const mime = (meta.match(/data:(.*);base64/) || [null,'image/png'])[1]; const ext = mime.split('/')[1] || 'png';
    const byteChars = atob(b64); const byteNumbers = new Array(byteChars.length); for(let i=0;i<byteChars.length;i++) byteNumbers[i]=byteChars.charCodeAt(i);
    const byteArray = new Uint8Array(byteNumbers); const blobImg = new Blob([byteArray], {type: mime}); const a2 = document.createElement('a'); a2.href = URL.createObjectURL(blobImg); a2.download = (note.title||'note').replace(/\s+/g,'_') + '.' + ext; a2.click(); URL.revokeObjectURL(a2.href);
  }
}

async function adminPost(path, payload){
  payload = payload || {}; payload.admin_login = current; payload.admin_password = currentPass;
  const r = await api(path, {method:'POST', body: JSON.stringify(payload)}); return r;
}

async function loadUsers(){
  const r = await adminPost('/admin/users/list', {}); const u = await r.json(); const div = el('usersList'); div.innerHTML='';
  for(const k of Object.keys(u)) div.innerHTML += `<div>${k} ‚Äî ${u[k].role}</div>`;
}

async function saveUser(){
  const login = el('u_login').value.trim(), pass = el('u_pass').value, roleSel = el('u_role').value;
  if(!login){ alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω'); return; }
  const payload = {login: login, role: roleSel}; if(pass) payload.password = pass;
  const r = await adminPost('/admin/users/add_or_update', payload); const j = await r.json(); if(!r.ok) alert(j.error || '–û—à–∏–±–∫–∞'); else { loadUsers(); loadUsersList(); el('u_login').value=''; el('u_pass').value=''; }
}

async function delUser(){
  const login = el('del_login').value.trim(); if(!login) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');
  const r = await adminPost('/admin/users/delete', {login}); const j = await r.json(); if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else { loadUsers(); loadUsersList(); el('del_login').value=''; }
}

async function editNotePrompt(idx,note){
  const newTitle = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', note.title); if(newTitle===null) return;
  const newDesc = prompt('–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ', note.desc); if(newDesc===null) return;
  const changeImg = confirm('–ó–∞–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ? OK ‚Äî –≤—ã–±—Ä–∞—Ç—å, Cancel ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–∂–Ω–µ–µ');
  let newImage = undefined;
  if(changeImg){
    const f = await pickFile(); if(f) newImage = await fileToDataURL(f);
  }
  const payload = {index: idx, title: newTitle, desc: newDesc}; if(newImage!==undefined) payload.image = newImage;
  const r = await adminPost('/admin/notes/update', payload); const j = await r.json(); if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else loadNotes();
}

function pickFile(){ return new Promise(res=>{ const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.onchange=()=>res(inp.files[0]||null); inp.click(); }); }

async function loadTheme(){
  try{ const r = await api('/admin/settings/theme'); const j = await r.json(); el('themeSel').value = j.theme || 'light'; applyTheme(j.theme||'light'); }catch(e){ applyTheme('light'); }
}
async function changeTheme(){ const theme = el('themeSel').value; await adminPost('/admin/settings/theme', {theme}); applyTheme(theme); }
function applyTheme(theme){
  if(theme==='dark'){ 
    document.documentElement.style.setProperty('--bg', 'var(--bg-dark)'); 
    document.documentElement.style.setProperty('--fg','var(--fg-dark)'); 
    document.documentElement.style.setProperty('--card','var(--card-dark)');
    document.documentElement.style.setProperty('--input-bg','var(--input-bg-dark)');
    document.documentElement.style.setProperty('--input-fg','var(--input-fg-dark)');
    document.documentElement.style.setProperty('--input-border','var(--input-border-dark)');
  }
  else { 
    document.documentElement.style.setProperty('--bg', 'var(--bg-light)'); 
    document.documentElement.style.setProperty('--fg','var(--fg-light)'); 
    document.documentElement.style.setProperty('--card','var(--card-light)');
    document.documentElement.style.setProperty('--input-bg','var(--input-bg-light)');
    document.documentElement.style.setProperty('--input-fg','var(--input-fg-light)');
    document.documentElement.style.setProperty('--input-border','var(--input-border-light)');
  }
}

applyTheme('light');

// --- Tests frontend ---
async function loadTests(){
  try{
    const r = await api('/tests'); const arr = await r.json();
    const list = el('testsList'); list.innerHTML='';
    arr.forEach((t)=>{
      const card = document.createElement('div'); card.className='note-card';
      card.innerHTML = `<h4>${escapeHtml(t.title)} <span class="small">(#${t.id||''})</span></h4><p class="small">${t.questions.length} –≤–æ–ø—Ä–æ—Å–æ–≤</p>`;
      const btn = document.createElement('button'); btn.className='btn ghost'; btn.textContent='–ü—Ä–æ–π—Ç–∏'; btn.onclick = ()=>startTest(t);
      card.appendChild(btn); list.appendChild(card);
    });
  }catch(e){ console.error(e); }
}

function startTest(test){
  const answers = [];
  for(let i=0;i<test.questions.length;i++){
    const q = test.questions[i] || {};
    const qtext = (q.q || q.question || q.text || '') + '';
    const rawChoices = Array.isArray(q.choices) ? q.choices : [];
    const choices = rawChoices.map(c=>{
      if (c === null || c === undefined) return '';
      if (typeof c === 'object') {
        return (c.text || c.label || c.choice || JSON.stringify(c));
      }
      return String(c);
    }).filter(s => s !== '');
    if(choices.length > 0){
      const promptText = (i+1)+'. '+qtext+'\n'+choices.map((c,idx)=>idx+': '+c).join('\n');
      const choice = prompt(promptText);
      if(choice===null){ alert('–¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ë–Ω'); return; }
      const trimmed = choice.trim();
      let num = parseInt(trimmed);
      if(isNaN(num)){
        const lowered = trimmed.toLowerCase();
        const matchIdx = choices.findIndex(c => (c+'').toLowerCase() === lowered);
        if(matchIdx !== -1){
          num = matchIdx;
        } else {
          const partial = choices.findIndex(c => (c+'').toLowerCase().includes(lowered) || lowered.includes((c+'').toLowerCase()));
          if(partial !== -1){
            num = partial;
          } else {
            num = -1;
          }
        }
      }
      answers.push(isNaN(num)?-1:num);
    } else {
      const free = prompt((i+1)+'. '+qtext+'\n(–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç)');
      if(free===null){ alert('–¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ë–Ω'); return; }
      answers.push(-1);
    }
  }
  (async ()=>{
    const r = await api('/tests/submit', {method:'POST', body: JSON.stringify({test_id: test.id, answers: answers, user: current})});
    const j = await r.json();
    alert('–†–µ–∑—É–ª—å—Ç–∞—Ç: '+j.score+'/'+j.total);
  })();
}

el('saveTestBtn')?.addEventListener('click', async ()=>{
  const title = el('testTitle').value.trim();
  const qsText = el('testQuestions').value.trim();
  if(!title || !qsText){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è'); return; }
  let qs;
  try{ qs = JSON.parse(qsText); }catch(e){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π JSON'); return; }
  const test = {title: title, questions: qs};
  const r = await adminPost('/admin/tests/add_or_update', {test}); const j = await r.json();
  if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else { alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. ID: '+j.id); el('testTitle').value=''; el('testQuestions').value=''; loadTests(); }
});

el('delTestBtn')?.addEventListener('click', async ()=>{
  const id = parseInt(el('delTestId').value);
  if(!id){ alert('–í–≤–µ–¥–∏—Ç–µ ID'); return; }
  const r = await adminPost('/admin/tests/delete', {id}); const j = await r.json();
  if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else { alert('–£–¥–∞–ª–µ–Ω–æ'); el('delTestId').value=''; loadTests(); }
});

el('loadResultsBtn')?.addEventListener('click', async ()=>{
  const r = await adminPost('/admin/results', {}); const j = await r.json();
  const div = el('resultsList'); div.innerHTML='';
  if(Array.isArray(j)) j.forEach(res=> div.innerHTML += `<div>${res.user} ‚Äî —Ç–µ—Å—Ç ${res.test_id} ${res.score}/${res.total}</div>`);
});

setTimeout(()=>{ if(document.getElementById('testsList')) loadTests(); }, 600);

// --- end tests frontend ---
</script>
</body>
</html>
