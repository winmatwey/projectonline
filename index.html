
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Online EDU Portal 7–ë</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg-light: #f4f6f9;
      --fg-light: #222;
      --card-light: #fff;
      --bg-dark: #0f1724;
      --fg-dark: #e6eef7;
      --card-dark: #111827;
      --primary: #0b5ea8;
      --muted: #6b7280;
      --success: #16a34a;
      --danger: #dc2626;
    }
    html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--fg)}
    .container{max-width:1100px;margin:20px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(11,94,168,0.06)}
    .login, .notes, .admin{margin-top:16px}
    input,textarea,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #d1d5db;box-sizing:border-box;margin-top:8px;font-size:14px}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .note-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    .note-card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.04)}
    .note-card h4{margin:0 0 6px 0;font-size:16px}
    .note-card p{margin:0;color:var(--muted);font-size:13px}
    .btn{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,94,168,0.12)}
    .btn.danger{background:var(--danger)}
    .small{font-size:12px;color:var(--muted);margin-top:6px}
    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:720px){ .row{flex-direction:column} .note-grid{grid-template-columns:repeat(1,1fr)} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìö Online EDU Portal 7–ë</h1>
      <div id="userInfo" class="small"></div>
    </header>

    <div id="loginBox" class="card login">
      <h3>–í—Ö–æ–¥</h3>
      <input id="login" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
      <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
      <div><button id="loginBtn" class="btn">–í–æ–π—Ç–∏</button></div>
      <div id="loginError" class="small" style="color:var(--danger)"></div>
    </div>

    <div id="mainBox" style="display:none">
      <div class="card notes">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç</h3>
          <div><button id="logoutBtn" class="btn ghost">–í—ã–π—Ç–∏</button></div>
        </div>
        <input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞">
        <textarea id="desc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></textarea>
        <input id="image" type="file" accept="image/*">
        <div style="display:flex;gap:8px;margin-top:8px"><button id="addNoteBtn" class="btn">–î–æ–±–∞–≤–∏—Ç—å</button><button id="refreshBtn" class="btn ghost">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button></div>
        <div id="notesList" class="note-grid"></div>
      </div>

      <div id="testsPanel" class="card tests" style="margin-top:12px">
        <h3>–¢–µ—Å—Ç—ã</h3>
        <div id="testsList" class="note-grid"></div>
      </div>

      <div id="adminPanel" class="card admin" style="display:none">
        <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
        <div style="display:flex;gap:12px;margin-bottom:8px">
          <input id="u_login" placeholder="–õ–æ–≥–∏–Ω">
          <input id="u_pass" placeholder="–ü–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)">
          <select id="u_role"><option value="student">student</option><option value="admin">admin</option></select>
          <button id="saveUserBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div style="display:flex;gap:12px;margin-bottom:8px">
          <input id="del_login" placeholder="–õ–æ–≥–∏–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è">
          <button id="delUserBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <label>–¢–µ–º–∞:</label>
          <select id="themeSel"><option value="light">–°–≤–µ—Ç–ª–∞—è</option><option value="dark">–¢—ë–º–Ω–∞—è</option></select>
        </div>
        <h4 style="margin-top:12px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏</h4>
        <div style="margin-bottom:8px">
          <input id="testTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞">
          <textarea id="testQuestions" placeholder='JSON –≤–æ–ø—Ä–æ—Å–æ–≤ (–ø—Ä–∏–º–µ—Ä: [{"q":"–í–æ–ø—Ä–æ—Å","choices":["a","b"],"correct":1}])' style="min-height:80px"></textarea>
          <button id="saveTestBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ—Å—Ç</button>
          <input id="delTestId" placeholder="ID —Ç–µ—Å—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è">
          <button id="delTestBtn" class="btn danger">–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç</button>
          <h4 style="margin-top:8px">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h4>
          <button id="loadResultsBtn" class="btn ghost">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
          <div id="resultsList" class="small" style="margin-top:8px"></div>
        </div>

        <h4 style="margin-top:12px">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
        <div id="usersList" class="small"></div>
      </div>
    </div>

    <footer class="small">Made for classroom ‚Äî keep it private.</code></footer>
  </div>

<script>
const API = ""; // same host
let current="", role="", currentPass="";

function el(id){return document.getElementById(id)}

async function api(path, opts){opts = opts || {}; opts.headers = opts.headers || {'Content-Type':'application/json'};
  try{const r = await fetch(path, opts); return r;}catch(e){throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç.')}}

async function loginAction(){
  el('loginError').textContent = '';
  const l = el('login').value.trim(), p = el('password').value;
  if(!l||!p){ el('loginError').textContent='–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; return; }
  const r = await api('/login',{method:'POST', body: JSON.stringify({login:l,password:p})});
  const d = await r.json();
  if(!d.ok){ el('loginError').textContent = d.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'; return; }
  current = l; role = d.role; currentPass = p;
  el('loginBox').style.display='none'; el('mainBox').style.display='block';
  el('userInfo').textContent = current + (role?' ('+role+')':'');
  if(role==='admin') el('adminPanel').style.display='block';
  loadNotes(); if(role==='admin') loadUsers(); loadTheme();
}

el('loginBtn').addEventListener('click', loginAction);
;
el('logoutBtn').addEventListener('click', ()=>location.reload());
el('addNoteBtn').addEventListener('click', addNote);
el('refreshBtn').addEventListener('click', loadNotes);
el('saveUserBtn').addEventListener('click', saveUser);
el('delUserBtn').addEventListener('click', delUser);
el('themeSel').addEventListener('change', changeTheme);

async function loadNotes(){
  const r = await api('/notes'); const arr = await r.json();
  const list = el('notesList'); list.innerHTML='';
  arr.forEach((n, idx)=>{
    const card = document.createElement('div'); card.className='note-card';
    card.innerHTML = `<h4>${escapeHtml(n.title)}</h4><p>${escapeHtml(n.desc)}</p><div class="small">–ê–≤—Ç–æ—Ä: ${escapeHtml(n.user)}</div>`;
    if(n.image){ const img = document.createElement('img'); img.src = n.image; img.style.maxWidth='100%'; img.style.marginTop='8px'; card.appendChild(img); }
    const btnRow = document.createElement('div'); btnRow.style.marginTop='8px';
    const dl = document.createElement('button'); dl.className='btn ghost'; dl.textContent='–°–∫–∞—á–∞—Ç—å'; dl.onclick = ()=>downloadNoteFiles(n);
    btnRow.appendChild(dl);
    if(role==='admin'){
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='–£–¥–∞–ª–∏—Ç—å'; del.style.marginLeft='8px';
      del.onclick = async ()=>{ if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç?')) return; await adminPost('/admin/notes/delete',{index:idx}); loadNotes(); };
      btnRow.appendChild(del);
      const edit = document.createElement('button'); edit.className='btn'; edit.textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'; edit.style.marginLeft='8px';
      edit.onclick = ()=>editNotePrompt(idx,n);
      btnRow.appendChild(edit);
    }
    card.appendChild(btnRow);
    list.appendChild(card);
  });
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

async function addNote(){
  if(!current){ alert('–í–æ–π–¥–∏—Ç–µ'); return; }
  const t = el('title').value.trim(), d = el('desc').value.trim();
  const f = el('image').files[0]; let img='';
  if(f) img = await fileToDataURL(f);
  await api('/notes',{method:'POST', body: JSON.stringify({title:t,desc:d,user:current,image:img})});
  el('title').value=''; el('desc').value=''; el('image').value='';
  loadNotes();
}

function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

async function downloadNoteFiles(note){
  // text
  const text = `–ù–∞–∑–≤–∞–Ω–∏–µ: ${note.title}\n–ê–≤—Ç–æ—Ä: ${note.user}\n\n–û–ø–∏—Å–∞–Ω–∏–µ:\n${note.desc}`;
  const blob = new Blob([text], {type: 'text/plain'});
  const a1 = document.createElement('a'); a1.href = URL.createObjectURL(blob); a1.download = (note.title||'note').replace(/\s+/g,'_') + '.txt'; a1.click(); URL.revokeObjectURL(a1.href);
  // image
  if(note.image){
    const parts = note.image.split(','); const meta = parts[0]; const b64 = parts[1] || '';
    const mime = (meta.match(/data:(.*);base64/) || [null,'image/png'])[1]; const ext = mime.split('/')[1] || 'png';
    const byteChars = atob(b64); const byteNumbers = new Array(byteChars.length); for(let i=0;i<byteChars.length;i++) byteNumbers[i]=byteChars.charCodeAt(i);
    const byteArray = new Uint8Array(byteNumbers); const blobImg = new Blob([byteArray], {type: mime}); const a2 = document.createElement('a'); a2.href = URL.createObjectURL(blobImg); a2.download = (note.title||'note').replace(/\s+/g,'_') + '.' + ext; a2.click(); URL.revokeObjectURL(a2.href);
  }
}

async function adminPost(path, payload){
  payload = payload || {}; payload.admin_login = current; payload.admin_password = currentPass;
  const r = await api(path, {method:'POST', body: JSON.stringify(payload)}); return r;
}

async function loadUsers(){
  const r = await adminPost('/admin/users/list', {}); const u = await r.json(); const div = el('usersList'); div.innerHTML='';
  for(const k of Object.keys(u)) div.innerHTML += `<div>${k} ‚Äî ${u[k].role}</div>`;
}

async function saveUser(){
  const login = el('u_login').value.trim(), pass = el('u_pass').value, roleSel = el('u_role').value;
  if(!login){ alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω'); return; }
  const payload = {login: login, role: roleSel}; if(pass) payload.password = pass;
  const r = await adminPost('/admin/users/add_or_update', payload); const j = await r.json(); if(!r.ok) alert(j.error || '–û—à–∏–±–∫–∞'); else { loadUsers(); el('u_login').value=''; el('u_pass').value=''; }
}

async function delUser(){
  const login = el('del_login').value.trim(); if(!login) return alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω');
  const r = await adminPost('/admin/users/delete', {login}); const j = await r.json(); if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else { loadUsers(); el('del_login').value=''; }
}

async function editNotePrompt(idx,note){
  const newTitle = prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', note.title); if(newTitle===null) return;
  const newDesc = prompt('–ù–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ', note.desc); if(newDesc===null) return;
  const changeImg = confirm('–ó–∞–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ? OK ‚Äî –≤—ã–±—Ä–∞—Ç—å, Cancel ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ–∂–Ω–µ–µ');
  let newImage = undefined;
  if(changeImg){
    const f = await pickFile(); if(f) newImage = await fileToDataURL(f);
  }
  const payload = {index: idx, title: newTitle, desc: newDesc}; if(newImage!==undefined) payload.image = newImage;
  const r = await adminPost('/admin/notes/update', payload); const j = await r.json(); if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else loadNotes();
}

function pickFile(){ return new Promise(res=>{ const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.onchange=()=>res(inp.files[0]||null); inp.click(); }); }

async function loadTheme(){
  try{ const r = await api('/admin/settings/theme'); const j = await r.json(); el('themeSel').value = j.theme || 'light'; applyTheme(j.theme||'light'); }catch(e){ applyTheme('light'); }
}
async function changeTheme(){ const theme = el('themeSel').value; await adminPost('/admin/settings/theme', {theme}); applyTheme(theme); }
function applyTheme(theme){
  if(theme==='dark'){ document.documentElement.style.setProperty('--bg', 'var(--bg-dark)'); document.documentElement.style.setProperty('--fg','var(--fg-dark)'); document.documentElement.style.setProperty('--card','var(--card-dark)'); }
  else { document.documentElement.style.setProperty('--bg', 'var(--bg-light)'); document.documentElement.style.setProperty('--fg','var(--fg-light)'); document.documentElement.style.setProperty('--card','var(--card-light)'); }
}

// initial apply
applyTheme('light');

// --- Tests frontend ---
async function loadTests(){
  try{
    const r = await api('/tests'); const arr = await r.json();
    const list = el('testsList'); list.innerHTML='';
    arr.forEach((t)=>{
      const card = document.createElement('div'); card.className='note-card';
      card.innerHTML = `<h4>${escapeHtml(t.title)} <span class="small">(#${t.id||''})</span></h4><p class="small">${t.questions.length} –≤–æ–ø—Ä–æ—Å–æ–≤</p>`;
      const btn = document.createElement('button'); btn.className='btn ghost'; btn.textContent='–ü—Ä–æ–π—Ç–∏'; btn.onclick = ()=>startTest(t);
      card.appendChild(btn); list.appendChild(card);
    });
  }catch(e){ console.error(e); }
}

function startTest(test){
  // simple prompt-based test flow
  const answers = [];
  for(let i=0;i<test.questions.length;i++){
    const q = test.questions[i];
    const choice = prompt((i+1)+'. '+q.q+'\n'+q.choices.map((c,idx)=>idx+': '+c).join('\n'));
    if(choice===null){ alert('–¢–µ—Å—Ç –æ—Ç–º–µ–Ω—ë–Ω'); return; }
    const num = parseInt(choice);
    answers.push(isNaN(num)?-1:num);
  }
  // submit answers
  (async ()=>{
    const r = await api('/tests/submit', {method:'POST', body: JSON.stringify({test_id: test.id, answers: answers, user: current})});
    const j = await r.json();
    alert('–†–µ–∑—É–ª—å—Ç–∞—Ç: '+j.score+'/'+j.total);
  })();
}

// Admin test management
el('saveTestBtn')?.addEventListener('click', async ()=>{
  const title = el('testTitle').value.trim();
  const qsText = el('testQuestions').value.trim();
  if(!title || !qsText){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è'); return; }
  let qs;
  try{ qs = JSON.parse(qsText); }catch(e){ alert('–ù–µ–≤–µ—Ä–Ω—ã–π JSON'); return; }
  const test = {title: title, questions: qs};
  const r = await adminPost('/admin/tests/add_or_update', {test}); const j = await r.json();
  if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else { alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. ID: '+j.id); el('testTitle').value=''; el('testQuestions').value=''; loadTests(); }
});

el('delTestBtn')?.addEventListener('click', async ()=>{
  const id = parseInt(el('delTestId').value);
  if(!id){ alert('–í–≤–µ–¥–∏—Ç–µ ID'); return; }
  const r = await adminPost('/admin/tests/delete', {id}); const j = await r.json();
  if(!r.ok) alert(j.error||'–û—à–∏–±–∫–∞'); else { alert('–£–¥–∞–ª–µ–Ω–æ'); el('delTestId').value=''; loadTests(); }
});

el('loadResultsBtn')?.addEventListener('click', async ()=>{
  const r = await adminPost('/admin/results', {}); const j = await r.json();
  const div = el('resultsList'); div.innerHTML='';
  if(Array.isArray(j)) j.forEach(res=> div.innerHTML += `<div>${res.user} ‚Äî —Ç–µ—Å—Ç ${res.test_id} ${res.score}/${res.total}</div>`);
});

// load tests on start
setTimeout(()=>{ if(document.getElementById('testsList')) loadTests(); }, 600);

// --- end tests frontend ---
</script>
</body>
</html>
